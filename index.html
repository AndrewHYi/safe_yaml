<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on http://github.com/jonrohan -->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen"/>
  <link rel="stylesheet" href="stylesheets/pygment_trac.css"/>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/script.js"></script>

  <title>SafeYAML</title>
  <meta name="description" content="Parse YAML safely, without that pesky arbitrary object deserialization vulnerability">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">SafeYAML</h1>
    </header>
    <div id="container">
      <p class="tagline">Parse YAML safely, without that pesky arbitrary object deserialization vulnerability</p>
      <div id="main" role="main">
        <div class="download-bar">
        <div class="inner">
          <a href="https://github.com/dtao/safe_yaml/tarball/master" class="download-button tar"><span>Download</span></a>
          <a href="https://github.com/dtao/safe_yaml/zipball/master" class="download-button zip"><span>Download</span></a>
          <a href="https://github.com/dtao/safe_yaml" class="code">View SafeYAML on GitHub</a>
        </div>
        <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">
          <h1>SafeYAML</h1>

<p><a href="http://travis-ci.org/dtao/safe_yaml"><img src="https://travis-ci.org/dtao/safe_yaml.png" alt="Build Status"></a></p>

<p>The <strong>SafeYAML</strong> gem provides an alternative implementation of <code>YAML.load</code> suitable for accepting user input in Ruby applications. Unlike Ruby's built-in implementation of <code>YAML.load</code>, SafeYAML's version will not expose apps to arbitrary code execution exploits (such as <a href="http://www.reddit.com/r/netsec/comments/167c11/serious_vulnerability_in_ruby_on_rails_allowing/">the ones discovered</a> <a href="http://www.h-online.com/open/news/item/Rails-developers-close-another-extremely-critical-flaw-1793511.html">in Rails in early 2013</a>).</p>

<p><strong>If you encounter any issues with SafeYAML, check out the 'Common Issues' section below.</strong> If you don't see anything that addresses the problem you're experiencing, by all means, <a href="https://github.com/dtao/safe_yaml/issues/new">create an issue</a>!</p>

<h2>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<pre><code>gem "safe_yaml"
</code></pre>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install safe_yaml
</code></pre>

<h2>Configuration</h2>

<p>Configuring SafeYAML should be quick. In most cases, you will probably only have to think about two things:</p>

<ol>
<li>What do you want the <code>YAML</code> module's <em>default</em> behavior to be? Set the <code>SafeYAML::OPTIONS[:default_mode]</code> option to either <code>:safe</code> or <code>:unsafe</code> to control this. If you do neither, SafeYAML will default to <code>:safe</code> mode but will issue a warning the first time you call <code>YAML.load</code>.</li>
<li>Do you want to allow symbols by default? Set the <code>SafeYAML::OPTIONS[:deserialize_symbols]</code> option to <code>true</code> or <code>false</code> to control this. The default is <code>false</code>, which means that SafeYAML will deserialize symbols in YAML documents as strings.</li>
</ol><p>For more information on these and other options, see the "Usage" section down below.</p>

<h2>Explanation</h2>

<p>Suppose your application were to use a popular open source library which contained code like this:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ClassBuilder</span>
  <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="vi">@class</span> <span class="o">||=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span>

    <span class="vi">@class</span><span class="o">.</span><span class="n">class_eval</span> <span class="o">&lt;&lt;-</span><span class="no">EOS</span>
<span class="sh">      def #{key}</span>
<span class="sh">        #{value}</span>
<span class="sh">      end</span>
<span class="no">    EOS</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@class</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Now, if you were to use <code>YAML.load</code> on user input anywhere in your application without the SafeYAML gem installed, an attacker who suspected you were using this library could send a request with a carefully-crafted YAML string to execute arbitrary code (yes, including <code>system("unix command")</code>) on your servers.</p>

<p>This simple example demonstrates the vulnerability:</p>

<div class="highlight"><pre><span class="n">yaml</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOYAML</span>
<span class="sh">--- !ruby/hash:ClassBuilder</span>
<span class="sh">"foo; end; puts %(I'm in yr system!); def bar": "baz"</span>
<span class="no">EOYAML</span>
</pre></div>

<pre><code>&gt; YAML.load(yaml)
I'm in yr system!
=&gt; #&lt;ClassBuilder:0x007fdbbe2e25d8 @class=#&lt;Class:0x007fdbbe2e2510&gt;&gt;
</code></pre>

<p>With SafeYAML, the same attacker would be thwarted:</p>

<pre><code>&gt; require "safe_yaml"
=&gt; true
&gt; YAML.load(yaml, :safe =&gt; true)
=&gt; {"foo; end; puts %(I'm in yr system!); def bar"=&gt;"baz"}
</code></pre>

<h2>Usage</h2>

<p>When you require the safe_yaml gem in your project, <code>YAML.load</code> is patched to accept one additional (optional) <code>options</code> parameter. This changes the method signature as follows:</p>

<ul>
<li>for Syck and Psych prior to Ruby 1.9.3: <code>YAML.load(yaml, options={})</code>
</li>
<li>for Psych in 1.9.3 and later: <code>YAML.load(yaml, filename=nil, options={})</code>
</li>
</ul><p>The most important option is the <code>:safe</code> option (default: <code>true</code>), which controls whether or not to deserialize arbitrary objects when parsing a YAML document. The other options, along with explanations, are as follows.</p>

<ul>
<li><p><code>:deserialize_symbols</code> (default: <code>false</code>): Controls whether or not YAML will deserialize symbols. It is probably best to only enable this option where necessary, e.g. to make trusted libraries work. Symbols receive special treatment in Ruby and are not garbage collected, which means deserializing them indiscriminately may render your site vulnerable to a DOS attack (hence <code>false</code> as a default value).</p></li>
<li><p><code>:whitelisted_tags</code>: Accepts an array of YAML tags that designate trusted types, e.g., ones that can be deserialized without worrying about any resulting security vulnerabilities. When any of the given tags are encountered in a YAML document, the associated data will be parsed by the underlying YAML engine (Syck or Psych) for the version of Ruby you are using. See the "Whitelisting Trusted Types" section below for more information.</p></li>
<li><p><code>:custom_initializers</code>: Similar to the <code>:whitelisted_tags</code> option, but allows you to provide your own initializers for specified tags rather than using Syck or Psyck. Accepts a hash with string tags for keys and lambdas for values.</p></li>
<li><p><code>:raise_on_unknown_tag</code> (default: <code>false</code>): Represents the highest possible level of paranoia (not necessarily a bad thing); if the YAML engine encounters any tag other than ones that are automatically trusted by SafeYAML or that you've explicitly whitelisted, it will raise an exception. This may be a good choice if you expect to always be dealing with perfectly safe YAML and want your application to fail loudly upon encountering questionable data.</p></li>
</ul><p>All of the above options can be set at the global level via <code>SafeYAML::OPTIONS</code>. You can also set each one individually per call to <code>YAML.load</code>; an option explicitly passed to <code>load</code> will take precedence over an option specified globally.</p>

<h2>Supported Types</h2>

<p>The way that SafeYAML works is by restricting the kinds of objects that can be deserialized via <code>YAML.load</code>. More specifically, only the following types of objects can be deserialized by default:</p>

<ul>
<li>Hashes</li>
<li>Arrays</li>
<li>Strings</li>
<li>Numbers</li>
<li>Dates</li>
<li>Times</li>
<li>Booleans</li>
<li>Nils</li>
</ul><p>Again, deserialization of symbols can be enabled globally by setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code>, or in a specific call to <code>YAML.load([some yaml], :deserialize_symbols =&gt; true)</code>.</p>

<h2>Whitelisting Trusted Types</h2>

<p>SafeYAML supports whitelisting certain YAML tags for trusted types. This is handy when your application uses YAML to serialize and deserialize certain types not listed above, which you know to be free of any deserialization-related vulnerabilities.</p>

<p>The easiest way to whitelist types is by calling <code>SafeYAML.whitelist!</code>, which can accept a variable number of safe types, e.g.:</p>

<div class="highlight"><pre><span class="no">SafeYAML</span><span class="o">.</span><span class="n">whitelist!</span><span class="p">(</span><span class="no">FrobDispenser</span><span class="p">,</span> <span class="no">GobbleFactory</span><span class="p">)</span>
</pre></div>

<p>You can also whitelist YAML <em>tags</em> via the <code>:whitelisted_tags</code> option:</p>

<div class="highlight"><pre><span class="c1"># Using Syck</span>
<span class="ss">SafeYAML</span><span class="p">:</span><span class="ss">:OPTIONS</span><span class="o">[</span><span class="ss">:whitelisted_tags</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"tag:ruby.yaml.org,2002:object:OpenStruct"</span><span class="o">]</span>

<span class="c1"># Using Psych</span>
<span class="ss">SafeYAML</span><span class="p">:</span><span class="ss">:OPTIONS</span><span class="o">[</span><span class="ss">:whitelisted_tags</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"!ruby/object:OpenStruct"</span><span class="o">]</span>
</pre></div>

<p>And in case you were wondering: no, this feature will <em>not</em> allow would-be attackers to embed untrusted types within trusted types:</p>

<div class="highlight"><pre><span class="n">yaml</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOYAML</span>
<span class="sh">--- !ruby/object:OpenStruct </span>
<span class="sh">table: </span>
<span class="sh">  :backdoor: !ruby/hash:ClassBuilder </span>
<span class="sh">    "foo; end; puts %(I'm in yr system!); def bar": "baz"</span>
<span class="no">EOYAML</span>
</pre></div>

<pre><code>&gt; YAML.safe_load(yaml)
=&gt; #&lt;OpenStruct :backdoor={"foo; end; puts %(I'm in yr system!); def bar"=&gt;"baz"}&gt;
</code></pre>

<h2>Known Issues</h2>

<p>If you add SafeYAML to your project and start seeing any errors about missing keys, or you notice mysterious strings that look like <code>":foo"</code> (i.e., start with a colon), it's likely you're seeing errors from symbols being saved in YAML format. If you are able to modify the offending code, you might want to consider changing your YAML content to use plain vanilla strings instead of symbols. If not, you may need to set the <code>:deserialize_symbols</code> option to <code>true</code>, either in calls to <code>YAML.load</code> or--as a last resort--globally, with <code>SafeYAML::OPTIONS[:deserialize_symbols]</code>.</p>

<p>Also be aware that some Ruby libraries, particularly those requiring inter-process communication, leverage YAML's object deserialization functionality and therefore may break or otherwise be impacted by SafeYAML. The following list includes known instances of SafeYAML's interaction with other Ruby gems:</p>

<ul>
<li>
<a href="https://github.com/rails/rails/tree/master/activerecord"><strong>ActiveRecord</strong></a>: uses YAML to control serialization of model objects using the <code>serialize</code> class method. If you find that accessing serialized properties on your ActiveRecord models is causing errors, chances are you may need to:

<ol>
<li>set the <code>:deserialize_symbols</code> option to <code>true</code>,</li>
<li>whitelist some of the types in your serialized data via <code>SafeYAML.whitelist!</code> or the <code>:whitelisted_tags</code> option, or</li>
<li>both</li>
</ol>
</li>
<li>
<a href="https://github.com/guard/guard"><strong>Guard</strong></a>: Uses YAML as a serialization format for notifications. The data serialized uses symbolic keys, so setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code> is necessary to allow Guard to work.</li>
<li>
<a href="https://github.com/mperham/sidekiq"><strong>sidekiq</strong></a>: Uses a YAML configiuration file with symbolic keys, so setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code> should allow it to work.</li>
</ul><p>The above list will grow over time, as more issues are discovered.</p>

<h2>Caveat</h2>

<p>My intention is to eventually adopt <a href="http://semver.org/">semantic versioning</a> with this gem, if it ever gets to version 1.0 (i.e., doesn't become obsolete by then). Since it isn't there yet, that means that API may well change from one version to the next. Please keep that in mind if you are using it in your application.</p>

<p>To be clear: my <em>goal</em> is for SafeYAML to make it as easy as possible to protect existing applications from object deserialization exploits. Any and all feedback is more than welcome!</p>

<h2>Requirements</h2>

<p>SafeYAML requires Ruby 1.8.7 or newer and works with both <a href="http://www.ruby-doc.org/stdlib-1.8.7/libdoc/yaml/rdoc/YAML.html">Syck</a> and <a href="http://github.com/tenderlove/psych">Psych</a>.</p>

<p>If you are using a version of Ruby where Psych is the default YAML engine (e.g., 1.9.3) but you want to use Syck, be sure to set <code>YAML::ENGINE.yamler = "syck"</code> <strong>before</strong> requiring the safe_yaml gem.</p>
        </article>
      </div>
    </div>
    <footer>
      <div class="owner">
      <p><a href="https://github.com/dtao" class="avatar"><img src="https://secure.gravatar.com/avatar/3c9c19ca551799cf691fddaae5056e55?s=30&amp;d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png" width="48" height="48"/></a> <a href="https://github.com/dtao">dtao</a> maintains <a href="https://github.com/dtao/safe_yaml">SafeYAML</a></p>


      </div>
      <div class="creds">
        <small>This page generated using <a href="https://pages.github.com/">GitHub Pages</a><br/>theme by <a href="http://twitter.com/jonrohan/">Jon Rohan</a></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/dtao/safe_yaml/tarball/master" class="tar">tar</a><a href="https://github.com/dtao/safe_yaml/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>

  
</body>
</html>
