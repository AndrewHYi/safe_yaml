<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>SafeYAML by dtao</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>SafeYAML</h1>
        <h2>Parse YAML safely, without that pesky arbitrary object deserialization vulnerability</h2>
        <a href="https://github.com/dtao/safe_yaml" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>SafeYAML</h1>

<p><a href="http://travis-ci.org/dtao/safe_yaml"><img src="https://travis-ci.org/dtao/safe_yaml.png" alt="Build Status"></a></p>

<p>The <strong>SafeYAML</strong> gem provides an alternative implementation of <code>YAML.load</code> suitable for accepting user input in Ruby applications. Unlike Ruby's built-in implementation of <code>YAML.load</code>, SafeYAML's version will not expose apps to arbitrary code execution exploits (such as <a href="http://www.reddit.com/r/netsec/comments/167c11/serious_vulnerability_in_ruby_on_rails_allowing/">the ones recently</a> <a href="http://www.h-online.com/open/news/item/Rails-developers-close-another-extremely-critical-flaw-1793511.html">discovered in Rails</a>).</p>

<h2>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<pre><code>gem "safe_yaml"
</code></pre>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install safe_yaml
</code></pre>

<h2>Purpose</h2>

<p>Suppose your application were to contain some code like this:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">ExploitableClassBuilder</span>
  <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="vi">@class</span> <span class="o">||=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span>

    <span class="vi">@class</span><span class="o">.</span><span class="n">class_eval</span> <span class="o">&lt;&lt;-</span><span class="no">EOS</span>
<span class="sh">      def #{key}</span>
<span class="sh">        #{value}</span>
<span class="sh">      end</span>
<span class="no">    EOS</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@class</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>

<p>Now, if you were to use <code>YAML.load</code> on user input anywhere in your application without the SafeYAML gem installed, an attacker could make a request with a carefully-crafted YAML string to execute arbitrary code (yes, including <code>system("unix command")</code>) on your servers.</p>

<p>Observe:</p>

<div class="highlight"><pre><span class="n">yaml</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOYAML</span>
<span class="sh">--- !ruby/hash:ExploitableClassBuilder</span>
<span class="sh">"foo; end; puts %(I'm in yr system!); def bar": "baz"</span>
<span class="no">EOYAML</span>
</pre></div>

<pre><code>&gt; YAML.load(yaml)
I'm in yr system!
=&gt; #&lt;ExploitableClassBuilder:0x007fdbbe2e25d8 @class=#&lt;Class:0x007fdbbe2e2510&gt;&gt;
</code></pre>

<p>With SafeYAML, that attacker would be thwarted:</p>

<pre><code>&gt; require "safe_yaml"
=&gt; true
&gt; YAML.safe_load(yaml)
=&gt; {"foo; end; puts %(I'm in yr system!); def bar"=&gt;"baz"}
</code></pre>

<h2>Usage</h2>

<p><code>YAML.safe_load</code> will load YAML without allowing arbitrary object deserialization.</p>

<p><code>YAML.unsafe_load</code> will exhibit Ruby's built-in behavior: to allow the deserialization of arbitrary objects.</p>

<p>By default, when you require the safe_yaml gem in your project, <code>YAML.load</code> is patched to internally call <code>safe_load</code>. The patched method also accepts a <code>:safe</code> flag to specify which version to use:</p>

<div class="highlight"><pre><span class="c1"># Ruby &gt;= 1.9.3</span>
<span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">:safe</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="c1"># calls safe_load</span>
<span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">:safe</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span> <span class="c1"># calls unsafe_load</span>

<span class="c1"># Ruby &lt; 1.9.3</span>
<span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">,</span> <span class="ss">:safe</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="c1"># calls safe_load</span>
<span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">yaml</span><span class="p">,</span> <span class="ss">:safe</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span> <span class="c1"># calls unsafe_load</span>
</pre></div>

<p>The default behavior can be switched to unsafe loading by calling <code>SafeYAML::OPTIONS[:default_mode] = :unsafe</code>. In this case, the <code>:safe</code> flag still has the same effect, but the defaults are reversed (so calling <code>YAML.load</code> will have the same behavior as if the safe_yaml gem weren't required).</p>

<p>This gem will also warn you whenever you use <code>YAML.load</code> without specifying the <code>:safe</code> option, or if you have not explicitly specified a default mode using the <code>:default_mode</code> option.</p>

<h2>Supported Types</h2>

<p>The way that SafeYAML works is by restricting the kinds of objects that can be deserialized via <code>YAML.load</code>. More specifically, only the following types of objects can be deserialized by default:</p>

<ul>
<li>Hashes</li>
<li>Arrays</li>
<li>Strings</li>
<li>Numbers</li>
<li>Dates</li>
<li>Times</li>
<li>Booleans</li>
<li>Nils</li>
</ul><p>Deserialization of symbols can also be enabled by setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code> (for example, in an initializer). Be aware, however, that symbols in Ruby are not garbage-collected; therefore enabling symbol deserialization in your application may leave you vulnerable to <a href="http://en.wikipedia.org/wiki/Denial-of-service_attack">DOS attacks</a>.</p>

<h2>Whitelisting Trusted Types</h2>

<p>SafeYAML now also supports <strong>whitelisting</strong> certain YAML tags for trusted types. This is handy when your application may use YAML to serialize and deserialize certain types not listed above, which you know to be free of any deserialization-related vulnerabilities. You can whitelist tags via the <code>:whitelisted_tags</code> option:</p>

<div class="highlight"><pre><span class="c1"># Using Syck (unfortunately, Syck and Psych use different tagging schemes)</span>
<span class="no">SafeYAML</span><span class="o">::</span><span class="no">OPTIONS</span><span class="o">[</span><span class="ss">:whitelisted_tags</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"tag:ruby.yaml.org,2002:object:OpenStruct"</span><span class="o">]</span>

<span class="c1"># Using Psych</span>
<span class="no">SafeYAML</span><span class="o">::</span><span class="no">OPTIONS</span><span class="o">[</span><span class="ss">:whitelisted_tags</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"!ruby/object:OpenStruct"</span><span class="o">]</span>
</pre></div>

<p>When SafeYAML encounters whitelisted tags in a YAML document, it will default to the deserialization capabilities of the underlying YAML engine (i.e., either Syck or Psych).</p>

<p><strong>However</strong>, this feature will <em>not</em> allow would-be attackers to embed untrusted types within trusted types:</p>

<div class="highlight"><pre><span class="n">yaml</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOYAML</span>
<span class="sh">--- !ruby/object:OpenStruct </span>
<span class="sh">table: </span>
<span class="sh">  :backdoor: !ruby/hash:ExploitableClassBuilder </span>
<span class="sh">    "foo; end; puts %(I'm in yr system!); def bar": "baz"</span>
<span class="no">EOYAML</span>
</pre></div>

<pre><code>&gt; YAML.safe_load(yaml)
=&gt; #&lt;OpenStruct :backdoor={"foo; end; puts %(I'm in yr system!); def bar"=&gt;"baz"}&gt;
</code></pre>

<p>You may prefer, rather than quietly sanitizing and accepting YAML documents with unknown tags, to fail loudly when questionable data is encountered. In this case, you can also set the <code>:raise_on_unknown_tag</code> option to <code>true</code>:</p>

<div class="highlight"><pre><span class="no">SafeYAML</span><span class="o">::</span><span class="no">OPTIONS</span><span class="o">[</span><span class="ss">:raise_on_unknown_tag</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>

<pre><code>&gt; YAML.safe_load(yaml)
=&gt; RuntimeError: Unknown YAML tag '!ruby/hash:ExploitableClassBuilder'
</code></pre>

<p>Pretty sweet, right?</p>

<h2>Known Issues</h2>

<p>Be aware that some Ruby libraries, particularly those requiring inter-process communication, leverage YAML's object deserialization functionality and therefore may break or otherwise be impacted by SafeYAML. The following list includes known instances of SafeYAML's interaction with other Ruby gems:</p>

<ul>
<li>
<a href="https://github.com/guard/guard"><strong>Guard</strong></a>: Uses YAML as a serialization format for notifications. The data serialized uses symbolic keys, so setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code> is necessary to allow Guard to work.</li>
<li>
<a href="https://github.com/mperham/sidekiq"><strong>sidekiq</strong></a>: Uses a YAML configiuration file with symbolic keys, so setting <code>SafeYAML::OPTIONS[:deserialize_symbols] = true</code> should allow it to work.</li>
</ul><p>The above list will grow over time, as more issues are discovered.</p>

<h2>Caveat</h2>

<p>This gem is quite young, and so the API may (read: <em>will</em>) change in future versions. The goal of the gem is to make it as easy as possible to protect existing applications from object deserialization exploits. Any and all feedback is more than welcome.</p>

<h2>Requirements</h2>

<p>SafeYAML requires Ruby 1.8.7 or newer and works with both <a href="http://www.ruby-doc.org/stdlib-1.8.7/libdoc/yaml/rdoc/YAML.html">Syck</a> and <a href="http://github.com/tenderlove/psych">Psych</a>.</p>

<p>If you are using a version of Ruby where Psych is the default YAML engine (e.g., 1.9.3) but you want to use Syck, be sure to set <code>YAML::ENGINE.yamler = "syck"</code> <strong>before</strong> requiring the safe_yaml gem.</p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/dtao/safe_yaml/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/dtao/safe_yaml/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/dtao/safe_yaml"></a> is maintained by <a href="https://github.com/dtao">dtao</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>