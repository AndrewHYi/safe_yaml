{"name":"SafeYAML","tagline":"Parse YAML safely, without that pesky arbitrary object deserialization vulnerability","body":"SafeYAML\r\n========\r\n\r\n[![Build Status](https://travis-ci.org/dtao/safe_yaml.png)](http://travis-ci.org/dtao/safe_yaml)\r\n\r\nThe **SafeYAML** gem provides an alternative implementation of `YAML.load` suitable for accepting user input in Ruby applications. Unlike Ruby's built-in implementation of `YAML.load`, SafeYAML's version will not expose apps to arbitrary code execution exploits (such as [the ones discovered](http://www.reddit.com/r/netsec/comments/167c11/serious_vulnerability_in_ruby_on_rails_allowing/) [in Rails in early 2013](http://www.h-online.com/open/news/item/Rails-developers-close-another-extremely-critical-flaw-1793511.html)).\r\n\r\n**If you encounter any issues with SafeYAML, check out the 'Common Issues' section below.** If you don't see anything that addresses the problem you're experiencing, by all means, [create an issue](https://github.com/dtao/safe_yaml/issues/new)!\r\n\r\nInstallation\r\n------------\r\n\r\nAdd this line to your application's Gemfile:\r\n\r\n    gem \"safe_yaml\"\r\n\r\nAnd then execute:\r\n\r\n    $ bundle\r\n\r\nOr install it yourself as:\r\n\r\n    $ gem install safe_yaml\r\n\r\nConfiguration\r\n-------------\r\n\r\nConfiguring SafeYAML should be quick. In most cases, you will probably only have to think about two things:\r\n\r\n1. What do you want the `YAML` module's *default* behavior to be? Set the `SafeYAML::OPTIONS[:default_mode]` option to either `:safe` or `:unsafe` to control this. If you do neither, SafeYAML will default to `:safe` mode but will issue a warning the first time you call `YAML.load`.\r\n2. Do you want to allow symbols by default? Set the `SafeYAML::OPTIONS[:deserialize_symbols]` option to `true` or `false` to control this. The default is `false`, which means that SafeYAML will deserialize symbols in YAML documents as strings.\r\n\r\nFor more information on these and other options, see the \"Usage\" section down below.\r\n\r\nExplanation\r\n-----------\r\n\r\nSuppose your application were to use a popular open source library which contained code like this:\r\n\r\n```ruby\r\nclass ClassBuilder\r\n  def []=(key, value)\r\n    @class ||= Class.new\r\n\r\n    @class.class_eval <<-EOS\r\n      def #{key}\r\n        #{value}\r\n      end\r\n    EOS\r\n  end\r\n\r\n  def create\r\n    @class.new\r\n  end\r\nend\r\n```\r\n\r\nNow, if you were to use `YAML.load` on user input anywhere in your application without the SafeYAML gem installed, an attacker who suspected you were using this library could send a request with a carefully-crafted YAML string to execute arbitrary code (yes, including `system(\"unix command\")`) on your servers.\r\n\r\nThis simple example demonstrates the vulnerability:\r\n\r\n```ruby\r\nyaml = <<-EOYAML\r\n--- !ruby/hash:ClassBuilder\r\n\"foo; end; puts %(I'm in yr system!); def bar\": \"baz\"\r\nEOYAML\r\n```\r\n\r\n    > YAML.load(yaml)\r\n    I'm in yr system!\r\n    => #<ClassBuilder:0x007fdbbe2e25d8 @class=#<Class:0x007fdbbe2e2510>>\r\n\r\nWith SafeYAML, the same attacker would be thwarted:\r\n\r\n    > require \"safe_yaml\"\r\n    => true\r\n    > YAML.load(yaml, :safe => true)\r\n    => {\"foo; end; puts %(I'm in yr system!); def bar\"=>\"baz\"}\r\n\r\nUsage\r\n-----\r\n\r\nWhen you require the safe_yaml gem in your project, `YAML.load` is patched to accept one additional (optional) `options` parameter. This changes the method signature as follows:\r\n\r\n- for Syck and Psych prior to Ruby 1.9.3: `YAML.load(yaml, options={})`\r\n- for Psych in 1.9.3 and later: `YAML.load(yaml, filename=nil, options={})`\r\n\r\nThe most important option is the `:safe` option (default: `true`), which controls whether or not to deserialize arbitrary objects when parsing a YAML document. The other options, along with explanations, are as follows.\r\n\r\n- `:deserialize_symbols` (default: `false`): Controls whether or not YAML will deserialize symbols. It is probably best to only enable this option where necessary, e.g. to make trusted libraries work. Symbols receive special treatment in Ruby and are not garbage collected, which means deserializing them indiscriminately may render your site vulnerable to a DOS attack (hence `false` as a default value).\r\n\r\n- `:whitelisted_tags`: Accepts an array of YAML tags that designate trusted types, e.g., ones that can be deserialized without worrying about any resulting security vulnerabilities. When any of the given tags are encountered in a YAML document, the associated data will be parsed by the underlying YAML engine (Syck or Psych) for the version of Ruby you are using. See the \"Whitelisting Trusted Types\" section below for more information.\r\n\r\n- `:custom_initializers`: Similar to the `:whitelisted_tags` option, but allows you to provide your own initializers for specified tags rather than using Syck or Psyck. Accepts a hash with string tags for keys and lambdas for values.\r\n\r\n- `:raise_on_unknown_tag` (default: `false`): Represents the highest possible level of paranoia (not necessarily a bad thing); if the YAML engine encounters any tag other than ones that are automatically trusted by SafeYAML or that you've explicitly whitelisted, it will raise an exception. This may be a good choice if you expect to always be dealing with perfectly safe YAML and want your application to fail loudly upon encountering questionable data.\r\n\r\nAll of the above options can be set at the global level via `SafeYAML::OPTIONS`. You can also set each one individually per call to `YAML.load`; an option explicitly passed to `load` will take precedence over an option specified globally.\r\n\r\nSupported Types\r\n---------------\r\n\r\nThe way that SafeYAML works is by restricting the kinds of objects that can be deserialized via `YAML.load`. More specifically, only the following types of objects can be deserialized by default:\r\n\r\n- Hashes\r\n- Arrays\r\n- Strings\r\n- Numbers\r\n- Dates\r\n- Times\r\n- Booleans\r\n- Nils\r\n\r\nAgain, deserialization of symbols can be enabled globally by setting `SafeYAML::OPTIONS[:deserialize_symbols] = true`, or in a specific call to `YAML.load([some yaml], :deserialize_symbols => true)`.\r\n\r\nWhitelisting Trusted Types\r\n--------------------------\r\n\r\nSafeYAML supports whitelisting certain YAML tags for trusted types. This is handy when your application uses YAML to serialize and deserialize certain types not listed above, which you know to be free of any deserialization-related vulnerabilities.\r\n\r\nThe easiest way to whitelist types is by calling `SafeYAML.whitelist!`, which can accept a variable number of safe types, e.g.:\r\n\r\n```ruby\r\nSafeYAML.whitelist!(FrobDispenser, GobbleFactory)\r\n```\r\n\r\nYou can also whitelist YAML *tags* via the `:whitelisted_tags` option:\r\n\r\n```ruby\r\n# Using Syck\r\nSafeYAML::OPTIONS[:whitelisted_tags] = [\"tag:ruby.yaml.org,2002:object:OpenStruct\"]\r\n\r\n# Using Psych\r\nSafeYAML::OPTIONS[:whitelisted_tags] = [\"!ruby/object:OpenStruct\"]\r\n```\r\n\r\nAnd in case you were wondering: no, this feature will *not* allow would-be attackers to embed untrusted types within trusted types:\r\n\r\n```ruby\r\nyaml = <<-EOYAML\r\n--- !ruby/object:OpenStruct \r\ntable: \r\n  :backdoor: !ruby/hash:ClassBuilder \r\n    \"foo; end; puts %(I'm in yr system!); def bar\": \"baz\"\r\nEOYAML\r\n```\r\n\r\n    > YAML.safe_load(yaml)\r\n    => #<OpenStruct :backdoor={\"foo; end; puts %(I'm in yr system!); def bar\"=>\"baz\"}>\r\n\r\nKnown Issues\r\n------------\r\n\r\nIf you add SafeYAML to your project and start seeing any errors about missing keys, or you notice mysterious strings that look like `\":foo\"` (i.e., start with a colon), it's likely you're seeing errors from symbols being saved in YAML format. If you are able to modify the offending code, you might want to consider changing your YAML content to use plain vanilla strings instead of symbols. If not, you may need to set the `:deserialize_symbols` option to `true`, either in calls to `YAML.load` or--as a last resort--globally, with `SafeYAML::OPTIONS[:deserialize_symbols]`.\r\n\r\nAlso be aware that some Ruby libraries, particularly those requiring inter-process communication, leverage YAML's object deserialization functionality and therefore may break or otherwise be impacted by SafeYAML. The following list includes known instances of SafeYAML's interaction with other Ruby gems:\r\n\r\n- [**ActiveRecord**](https://github.com/rails/rails/tree/master/activerecord): uses YAML to control serialization of model objects using the `serialize` class method. If you find that accessing serialized properties on your ActiveRecord models is causing errors, chances are you may need to:\r\n  1. set the `:deserialize_symbols` option to `true`,\r\n  2. whitelist some of the types in your serialized data via `SafeYAML.whitelist!` or the `:whitelisted_tags` option, or\r\n  3. both\r\n- [**Guard**](https://github.com/guard/guard): Uses YAML as a serialization format for notifications. The data serialized uses symbolic keys, so setting `SafeYAML::OPTIONS[:deserialize_symbols] = true` is necessary to allow Guard to work.\r\n- [**sidekiq**](https://github.com/mperham/sidekiq): Uses a YAML configiuration file with symbolic keys, so setting `SafeYAML::OPTIONS[:deserialize_symbols] = true` should allow it to work.\r\n\r\nThe above list will grow over time, as more issues are discovered.\r\n\r\nCaveat\r\n------\r\n\r\nMy intention is to eventually adopt [semantic versioning](http://semver.org/) with this gem, if it ever gets to version 1.0 (i.e., doesn't become obsolete by then). Since it isn't there yet, that means that API may well change from one version to the next. Please keep that in mind if you are using it in your application.\r\n\r\nTo be clear: my *goal* is for SafeYAML to make it as easy as possible to protect existing applications from object deserialization exploits. Any and all feedback is more than welcome!\r\n\r\nRequirements\r\n------------\r\n\r\nSafeYAML requires Ruby 1.8.7 or newer and works with both [Syck](http://www.ruby-doc.org/stdlib-1.8.7/libdoc/yaml/rdoc/YAML.html) and [Psych](http://github.com/tenderlove/psych).\r\n\r\nIf you are using a version of Ruby where Psych is the default YAML engine (e.g., 1.9.3) but you want to use Syck, be sure to set `YAML::ENGINE.yamler = \"syck\"` **before** requiring the safe_yaml gem.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}